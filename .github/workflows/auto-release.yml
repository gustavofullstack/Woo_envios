name: Auto Release Plugin

on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '!README.md'
      - '!.github/**'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        tools: composer:v2

    - name: Install Composer Dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Get Current Version
      id: version
      run: |
        VERSION=$(grep "Version:" woo-envios.php | awk '{print $3}')
        echo "Current version: $VERSION"
        echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV

    - name: Bump Version
      id: bump_version
      run: |
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        echo "Bumping to: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" woo-envios.php
        sed -i "s/const VERSION = '$CURRENT_VERSION';/const VERSION = '$NEW_VERSION';/" woo-envios.php

    - name: Get Commits and Changes Since Last Tag
      id: commits
      run: |
        # Get the last tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        echo "Last tag: $LAST_TAG"
        
        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"%h - %s (%an)" -n 15)
          FILES_CHANGED=$(git diff --stat HEAD~15 HEAD 2>/dev/null | tail -20)
        else
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%h - %s (%an)" --no-merges)
          FILES_CHANGED=$(git diff --stat ${LAST_TAG}..HEAD 2>/dev/null | tail -20)
        fi
        
        # Get the actual code diff (limited)
        if [ -n "$LAST_TAG" ]; then
          CODE_DIFF=$(git diff ${LAST_TAG}..HEAD --no-color -- '*.php' | head -100)
        else
          CODE_DIFF=$(git diff HEAD~5..HEAD --no-color -- '*.php' | head -100)
        fi
        
        # Save to files
        echo "$COMMITS" > commits.txt
        echo "$FILES_CHANGED" > files_changed.txt
        echo "$CODE_DIFF" > code_diff.txt
        
        echo "=== COMMITS ==="
        cat commits.txt
        echo ""
        echo "=== FILES CHANGED ==="
        cat files_changed.txt
        
        echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV

    - name: Generate AI Changelog with DeepSeek
      id: ai_changelog
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        VERSION="${{ steps.bump_version.outputs.new_version }}"
        COMMITS=$(cat commits.txt)
        FILES=$(cat files_changed.txt)
        DIFF=$(cat code_diff.txt | head -80)
        TIMESTAMP=$(date +%s)
        
        if [ -n "$DEEPSEEK_API_KEY" ]; then
          echo "ðŸ¤– Generating changelog with DeepSeek AI..."
          
          # Build a detailed prompt with all context
          PROMPT="VocÃª Ã© um redator tÃ©cnico especializado em changelogs de plugins WordPress.

CONTEXTO: Plugin Woo Envios - CÃ¡lculo de frete WooCommerce com Google Maps e SuperFrete.

VERSÃƒO: v${VERSION}
TIMESTAMP: ${TIMESTAMP}

COMMITS DESTA RELEASE:
${COMMITS}

ARQUIVOS MODIFICADOS:
${FILES}

TRECHO DO CÃ“DIGO ALTERADO:
\`\`\`php
${DIFF}
\`\`\`

INSTRUÃ‡Ã•ES OBRIGATÃ“RIAS:
1. Analise CADA commit individualmente e descreva o que foi feito
2. Use o diff do cÃ³digo para entender as mudanÃ§as REAIS
3. NÃƒO repita informaÃ§Ãµes genÃ©ricas - seja ESPECÃFICO
4. Mencione nomes de arquivos, classes e mÃ©todos quando relevante
5. Se houver correÃ§Ã£o de bug, explique qual era o problema e como foi resolvido
6. NUNCA use frases genÃ©ricas como 'melhorias gerais' ou 'correÃ§Ãµes de bugs'

FORMATO (use exatamente este):

## ðŸ› CorreÃ§Ãµes
- [descriÃ§Ã£o especÃ­fica da correÃ§Ã£o]

## âœ¨ Novidades  
- [descriÃ§Ã£o especÃ­fica da novidade]

## ðŸ”§ Melhorias
- [descriÃ§Ã£o especÃ­fica da melhoria]

## ðŸ“ Arquivos Alterados
- [lista dos principais arquivos modificados]

IMPORTANTE: Gere APENAS o conteÃºdo do changelog, sem introduÃ§Ãµes ou conclusÃµes.
Cada item deve ser ÃšNICO e baseado nas mudanÃ§as REAIS do cÃ³digo."

          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          RESPONSE=$(curl -s -X POST "https://api.deepseek.com/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -d "{
              \"model\": \"deepseek-chat\",
              \"messages\": [{\"role\": \"user\", \"content\": $ESCAPED_PROMPT}],
              \"temperature\": 0.3,
              \"max_tokens\": 1500
            }")
          
          CHANGELOG=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          
          if [ -n "$CHANGELOG" ] && [ "$CHANGELOG" != "null" ]; then
            echo "âœ… AI Changelog generated!"
            
            cat > release_notes.txt << EOF
# ðŸš€ Woo Envios v${VERSION}

${CHANGELOG}

---

ðŸ“… **Data:** $(date +"%d/%m/%Y Ã s %H:%M")
ðŸ“¦ **Arquivo:** \`woo-envios.zip\`
ðŸ”„ **AtualizaÃ§Ã£o:** DisponÃ­vel automaticamente no WordPress
ðŸ·ï¸ **Tag anterior:** ${LAST_TAG:-"Nenhuma"}

> âš¡ Changelog gerado por IA (DeepSeek) - ID: ${TIMESTAMP}
EOF
          else
            echo "âš ï¸ AI failed, using fallback..."
            cat > release_notes.txt << EOF
# ðŸš€ Woo Envios v${VERSION}

## ðŸ“‹ Commits desta versÃ£o

${COMMITS}

## ðŸ“ Arquivos modificados

\`\`\`
${FILES}
\`\`\`

---

ðŸ“… **Data:** $(date +"%d/%m/%Y Ã s %H:%M")
ðŸ“¦ **Arquivo:** \`woo-envios.zip\`
EOF
          fi
        else
          echo "âš ï¸ No API key, using commit log..."
          cat > release_notes.txt << EOF
# ðŸš€ Woo Envios v${VERSION}

## ðŸ“‹ Commits

${COMMITS}

## ðŸ“ Arquivos modificados

\`\`\`
${FILES}
\`\`\`

---

ðŸ“… **Data:** $(date +"%d/%m/%Y Ã s %H:%M")
EOF
        fi
        
        echo "ðŸ“ Release notes:"
        cat release_notes.txt

    - name: Commit Version Bump
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add woo-envios.php
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }} [skip ci]"
          git push
        fi

    - name: Create Zip Artifact
      run: |
        mkdir -p build/woo-envios
        
        rsync -av --progress . build/woo-envios \
          --exclude .git \
          --exclude .github \
          --exclude build \
          --exclude composer.json \
          --exclude composer.lock \
          --exclude .gitignore \
          --exclude 'test-*.php' \
          --exclude commits.txt \
          --exclude files_changed.txt \
          --exclude code_diff.txt \
          --exclude release_notes.txt
        
        cd build
        zip -r ../woo-envios.zip woo-envios

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ steps.bump_version.outputs.new_version }}
        name: "v${{ steps.bump_version.outputs.new_version }} - Woo Envios"
        artifacts: "woo-envios.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
        bodyFile: release_notes.txt
        makeLatest: true

    - name: Update CHANGELOG.md
      run: |
        VERSION="${{ steps.bump_version.outputs.new_version }}"
        DATE=$(date +"%Y-%m-%d")
        COMMITS=$(cat commits.txt)
        
        NEW_ENTRY="## [${VERSION}] - ${DATE}

${COMMITS}

---
"
        
        if [ -f "CHANGELOG.md" ]; then
          # Insert after first line (title)
          head -2 CHANGELOG.md > temp_changelog.md
          echo "" >> temp_changelog.md
          echo "$NEW_ENTRY" >> temp_changelog.md
          tail -n +3 CHANGELOG.md >> temp_changelog.md
          mv temp_changelog.md CHANGELOG.md
        else
          echo -e "# Changelog\n\n${NEW_ENTRY}" > CHANGELOG.md
        fi
        
        git add CHANGELOG.md
        if ! git diff --staged --quiet; then
          git commit -m "docs: update CHANGELOG.md for v${VERSION} [skip ci]"
          git push
        fi
