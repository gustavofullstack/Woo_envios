name: Auto Release Plugin

on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '!README.md'
      - '!.github/**'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        tools: composer:v2

    - name: Install Composer Dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Get Current Version
      id: version
      run: |
        VERSION=$(grep "Version:" woo-envios.php | awk '{print $3}')
        echo "Current version: $VERSION"
        echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV

    - name: Bump Version
      id: bump_version
      run: |
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        echo "Bumping to: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" woo-envios.php
        sed -i "s/const VERSION = '$CURRENT_VERSION';/const VERSION = '$NEW_VERSION';/" woo-envios.php

    - name: Get Commits and Changes Since Last Tag
      id: commits
      run: |
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        echo "Last tag: $LAST_TAG"
        
        if [ -z "$LAST_TAG" ]; then
          COMMITS=$(git log --pretty=format:"%h - %s" -n 15)
          FILES_CHANGED=$(git diff --stat HEAD~15 HEAD 2>/dev/null | tail -20)
        else
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%h - %s" --no-merges)
          FILES_CHANGED=$(git diff --stat ${LAST_TAG}..HEAD 2>/dev/null | tail -20)
        fi
        
        echo "$COMMITS" > commits.txt
        echo "$FILES_CHANGED" > files_changed.txt
        
        echo "=== COMMITS ==="
        cat commits.txt
        echo ""
        echo "=== FILES ==="
        cat files_changed.txt
        
        echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV

    - name: Generate AI Changelog with DeepSeek
      id: ai_changelog
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        VERSION="${{ steps.bump_version.outputs.new_version }}"
        COMMITS=$(cat commits.txt)
        FILES=$(cat files_changed.txt)
        TIMESTAMP=$(date +%s)
        
        if [ -n "$DEEPSEEK_API_KEY" ]; then
          echo "ðŸ¤– Generating changelog with DeepSeek AI..."
          
          cat > prompt.txt << 'PROMPT_END'
        Voce e um redator tecnico. Gere um changelog em portugues para o plugin Woo Envios.
        
        REGRAS:
        1. Analise cada commit e descreva especificamente
        2. Use emojis: bug fix, star novidade, wrench melhoria
        3. Mencione arquivos e metodos quando relevante
        4. NAO use frases genericas
        5. Seja conciso
        
        FORMATO:
        ## Correcoes
        - item
        
        ## Novidades
        - item
        
        ## Melhorias
        - item
        PROMPT_END
          
          echo "" >> prompt.txt
          echo "VERSAO: v${VERSION}" >> prompt.txt
          echo "" >> prompt.txt
          echo "COMMITS:" >> prompt.txt
          cat commits.txt >> prompt.txt
          echo "" >> prompt.txt
          echo "ARQUIVOS:" >> prompt.txt
          cat files_changed.txt >> prompt.txt
          
          PROMPT_CONTENT=$(cat prompt.txt | jq -Rs .)
          
          curl -s -X POST "https://api.deepseek.com/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -d "{\"model\":\"deepseek-chat\",\"messages\":[{\"role\":\"user\",\"content\":$PROMPT_CONTENT}],\"temperature\":0.3,\"max_tokens\":1500}" \
            > response.json
          
          CHANGELOG=$(cat response.json | jq -r '.choices[0].message.content // empty')
          
          if [ -n "$CHANGELOG" ] && [ "$CHANGELOG" != "null" ]; then
            echo "âœ… AI Changelog generated!"
            
            echo "# Woo Envios v${VERSION}" > release_notes.txt
            echo "" >> release_notes.txt
            echo "$CHANGELOG" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "---" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "ðŸ“… **Data:** $(date +'%d/%m/%Y %H:%M')" >> release_notes.txt
            echo "ðŸ“¦ **Arquivo:** woo-envios.zip" >> release_notes.txt
            echo "ðŸ·ï¸ **Tag anterior:** ${LAST_TAG:-Nenhuma}" >> release_notes.txt
            echo "" >> release_notes.txt
            echo "> Changelog by DeepSeek AI - ${TIMESTAMP}" >> release_notes.txt
          else
            echo "âš ï¸ AI failed, using fallback..."
            echo "# Woo Envios v${VERSION}" > release_notes.txt
            echo "" >> release_notes.txt
            echo "## Commits" >> release_notes.txt
            echo "" >> release_notes.txt
            cat commits.txt >> release_notes.txt
            echo "" >> release_notes.txt
            echo "## Arquivos modificados" >> release_notes.txt
            echo "" >> release_notes.txt
            cat files_changed.txt >> release_notes.txt
          fi
        else
          echo "âš ï¸ No API key..."
          echo "# Woo Envios v${VERSION}" > release_notes.txt
          echo "" >> release_notes.txt
          echo "## Commits" >> release_notes.txt
          cat commits.txt >> release_notes.txt
        fi
        
        echo "ðŸ“ Release notes:"
        cat release_notes.txt

    - name: Commit Version Bump
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add woo-envios.php
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }} [skip ci]"
          git push
        fi

    - name: Create Zip Artifact
      run: |
        mkdir -p build/woo-envios
        
        rsync -av --progress . build/woo-envios \
          --exclude .git \
          --exclude .github \
          --exclude build \
          --exclude composer.json \
          --exclude composer.lock \
          --exclude .gitignore \
          --exclude 'test-*.php' \
          --exclude '*.txt' \
          --exclude '*.json'
        
        cd build
        zip -r ../woo-envios.zip woo-envios

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ steps.bump_version.outputs.new_version }}
        name: "v${{ steps.bump_version.outputs.new_version }} - Woo Envios"
        artifacts: "woo-envios.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
        bodyFile: release_notes.txt
        makeLatest: true

    - name: Update CHANGELOG.md
      run: |
        VERSION="${{ steps.bump_version.outputs.new_version }}"
        DATE=$(date +"%Y-%m-%d")
        COMMITS=$(cat commits.txt)
        
        if [ -f "CHANGELOG.md" ]; then
          echo "## [${VERSION}] - ${DATE}" > temp_entry.txt
          echo "" >> temp_entry.txt
          echo "$COMMITS" >> temp_entry.txt
          echo "" >> temp_entry.txt
          echo "---" >> temp_entry.txt
          echo "" >> temp_entry.txt
          
          head -2 CHANGELOG.md > new_changelog.md
          echo "" >> new_changelog.md
          cat temp_entry.txt >> new_changelog.md
          tail -n +3 CHANGELOG.md >> new_changelog.md
          mv new_changelog.md CHANGELOG.md
          rm temp_entry.txt
        else
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## [${VERSION}] - ${DATE}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "$COMMITS" >> CHANGELOG.md
        fi
        
        git add CHANGELOG.md
        if ! git diff --staged --quiet; then
          git commit -m "docs: update CHANGELOG.md for v${VERSION} [skip ci]"
          git push
        fi
