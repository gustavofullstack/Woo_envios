name: Auto Release Plugin

on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '!README.md'
      - '!.github/**'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    # Needs permissions to push to main
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        tools: composer:v2

    - name: Install Composer Dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Get Current Version
      id: version
      run: |
        # Extract version from woo-envios.php
        VERSION=$(grep "Version:" woo-envios.php | awk '{print $3}')
        echo "Current version: $VERSION"
        echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV

    - name: Bump Version
      id: bump_version
      run: |
        # Simple patch version bump logic
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        echo "Bumping to: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # Update header
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" woo-envios.php
        # Update constant if exists
        sed -i "s/const VERSION = '$CURRENT_VERSION';/const VERSION = '$NEW_VERSION';/" woo-envios.php

    - name: Commit Version Bump
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add woo-envios.php
        # Check if there are changes before committing
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }} [skip ci]"
          git push
        fi

    - name: Create Zip Artifact
      run: |
        # Create a build directory
        mkdir -p build/woo-envios
        
        # Copy files to build dir, excluding unwanted
        rsync -av --progress . build/woo-envios --exclude .git --exclude .github --exclude build --exclude composer.json --exclude composer.lock --exclude .gitignore --exclude test-*.php
        
        # Zip it
        cd build
        zip -r ../woo-envios.zip woo-envios

    - name: Extract Changelog for Version
      id: changelog
      run: |
        VERSION="${{ steps.bump_version.outputs.new_version }}"
        
        # Extract the section for this version from CHANGELOG.md
        if [ -f "CHANGELOG.md" ]; then
          # Use awk to extract the section for the latest version
          NOTES=$(awk '/^## \[/{if(found) exit; found=1} found{print}' CHANGELOG.md | tail -n +2)
          
          if [ -z "$NOTES" ]; then
            printf "ðŸš€ Release v%s\n\nðŸ“¦ **Novidades desta versÃ£o:**\n- Melhorias gerais e correÃ§Ãµes de bugs\n- Veja o CHANGELOG.md para detalhes completos\n" "$VERSION" > release_notes.txt
          else
            echo "$NOTES" > release_notes.txt
          fi
        else
          echo "ðŸš€ Release v${VERSION}" > release_notes.txt
        fi


    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ steps.bump_version.outputs.new_version }}
        name: "ðŸš€ Release v${{ steps.bump_version.outputs.new_version }}"
        artifacts: "woo-envios.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
        bodyFile: release_notes.txt
        makeLatest: true
