name: Auto Release Plugin

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
      - 'README.md'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'

    - name: Get current version
      id: version
      run: |
        echo "CURRENT_VERSION=$(grep "Version:" woo-envios.php | awk '{print $3}')" >> $GITHUB_ENV

    - name: Bump version
      id: bump_version
      run: |
        # Separar versão X.Y.Z
        IFS='.' read -r major minor patch <<< "${{ env.CURRENT_VERSION }}"
        NEW_VERSION="$major.$minor.$((patch + 1))"
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
        
        # Atualizar arquivos
        sed -i "s/Version: ${{ env.CURRENT_VERSION }}/Version: $NEW_VERSION/" woo-envios.php
        sed -i "s/VERSION = '${{ env.CURRENT_VERSION }}'/VERSION = '$NEW_VERSION'/" woo-envios.php
        
        # Output para o job
        echo "Created new version: $NEW_VERSION"

    - name: Commit version bump
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add woo-envios.php
        git commit -m "chore: bump version to ${{ env.NEW_VERSION }}"
        git push origin main

    - name: Create ZIP artifact
      run: |
        # Criar pasta temporária para zipar limpo (sem arquivos ocultos/git)
        mkdir woo-envios
        rsync -av --progress . woo-envios --exclude .git --exclude .github --exclude woo-envios --exclude .gitignore
        zip -r "woo-envios-${{ env.NEW_VERSION }}.zip" woo-envios

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ env.NEW_VERSION }}"
        name: "Release v${{ env.NEW_VERSION }}"
        body: "Auto-generated release from commit ${{ github.sha }}"
        files: "woo-envios-${{ env.NEW_VERSION }}.zip"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
