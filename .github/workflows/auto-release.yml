name: Auto Release Plugin

on:
  push:
    branches:
      - main
    paths-ignore:
      - '.github/**'
      - 'README.md'

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'

    - name: Get current version
      id: version
      run: |
        echo "CURRENT_VERSION=$(grep "Version:" woo-envios.php | awk '{print $3}')" >> $GITHUB_ENV

    - name: Bump version
      id: bump_version
      run: |
        # Separar versão X.Y.Z
        IFS='.' read -r major minor patch <<< "$CURRENT_VERSION"
        NEW_VERSION="$major.$minor.$((patch + 1))"
        # Exportar para ENV (scripts subsequentes) e OUTPUT (steps subsequentes)
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
        echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        # Atualizar arquivos PHP
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" woo-envios.php
        sed -i "s/VERSION = '$CURRENT_VERSION'/VERSION = '$NEW_VERSION'/" woo-envios.php
        
        # Output para o job
        echo "Created new version: $NEW_VERSION"

    - name: Update plugin-update.json
      run: |
        # Atualiza a versão no JSON
        sed -i "s/\"version\": \".*\"/\"version\": \"$NEW_VERSION\"/" plugin-update.json
        
        # Atualiza a URL de download (Ex: .../v3.1.1/woo-envios-3.1.1.zip)
        DOWNLOAD_URL="https://github.com/gustavofullstack/Woo_envios/releases/download/v$NEW_VERSION/woo-envios-$NEW_VERSION.zip"
        # Usando separador | no sed para evitar conflito com barras da URL
        sed -i "s|\"download_url\": \".*\"|\"download_url\": \"$DOWNLOAD_URL\"|" plugin-update.json
        
        # Atualiza data
        NOW=$(date '+%Y-%m-%d %H:%M:%S')
        sed -i "s|\"last_updated\": \".*\"|\"last_updated\": \"$NOW\"|" plugin-update.json
        
        # Atualiza changelog (exemplo simples)
        NEW_CHANGELOG="<h4>$NEW_VERSION</h4><ul><li>Release automática gerada em $NOW</li></ul>"
        sed -i "s|\"changelog\": \".*\"|\"changelog\": \"$NEW_CHANGELOG\"|" plugin-update.json

    - name: Commit version bump
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add woo-envios.php plugin-update.json
        git commit -m "chore: bump version to $NEW_VERSION"
        git push origin main

    - name: Create ZIP artifact
      run: |
        # Criar pasta temporária para zipar limpo
        mkdir woo-envios
        rsync -av --progress . woo-envios --exclude .git --exclude .github --exclude woo-envios --exclude .gitignore --exclude test-envios.php --exclude update_pricing.sql --exclude ATUALIZAR_PRECOS.txt
        zip -r "woo-envios-$NEW_VERSION.zip" woo-envios

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: "v${{ steps.bump_version.outputs.NEW_VERSION }}"
        name: "Release v${{ steps.bump_version.outputs.NEW_VERSION }}"
        body: "Auto-generated release from commit ${{ github.sha }}"
        files: "woo-envios-${{ steps.bump_version.outputs.NEW_VERSION }}.zip"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
