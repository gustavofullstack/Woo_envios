name: Auto Release Plugin

on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '!README.md'
      - '!.github/**'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.0'
        tools: composer:v2

    - name: Install Composer Dependencies
      run: composer install --no-dev --optimize-autoloader

    - name: Get Current Version
      id: version
      run: |
        VERSION=$(grep "Version:" woo-envios.php | awk '{print $3}')
        echo "Current version: $VERSION"
        echo "CURRENT_VERSION=$VERSION" >> $GITHUB_ENV

    - name: Bump Version
      id: bump_version
      run: |
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        
        echo "Bumping to: $NEW_VERSION"
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" woo-envios.php
        sed -i "s/const VERSION = '$CURRENT_VERSION';/const VERSION = '$NEW_VERSION';/" woo-envios.php

    - name: Get Commits Since Last Tag
      id: commits
      run: |
        # Get the last tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          # No previous tag, get last 10 commits
          COMMITS=$(git log --pretty=format:"- %s" -n 10)
        else
          # Get commits since last tag
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
        fi
        
        # Save commits to file for DeepSeek
        echo "$COMMITS" > commits.txt
        cat commits.txt
        
        # Export for later steps
        echo "LAST_TAG=$LAST_TAG" >> $GITHUB_ENV

    - name: Generate AI Changelog with DeepSeek
      id: ai_changelog
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        VERSION="${{ steps.bump_version.outputs.new_version }}"
        COMMITS=$(cat commits.txt)
        
        # Only use AI if API key is available
        if [ -n "$DEEPSEEK_API_KEY" ]; then
          echo "ðŸ¤– Generating changelog with DeepSeek AI..."
          
          # Prepare the prompt
          PROMPT="VocÃª Ã© um assistente especializado em gerar changelogs profissionais para plugins WordPress.

        Baseado nos seguintes commits, gere um changelog em portuguÃªs brasileiro para a versÃ£o v${VERSION} do plugin Woo Envios:

        COMMITS:
        ${COMMITS}

        REGRAS:
        1. Agrupe as mudanÃ§as por categoria: ðŸ› CorreÃ§Ãµes, âœ¨ Novidades, ðŸ”§ Melhorias, ðŸ“¦ Outros
        2. Use emojis para cada item
        3. Seja conciso mas informativo
        4. Ignore commits de bump de versÃ£o ou [skip ci]
        5. Destaque correÃ§Ãµes crÃ­ticas primeiro
        6. Formato Markdown
        7. MÃ¡ximo 300 palavras

        Gere APENAS o changelog, sem introduÃ§Ãµes."

          # Escape the prompt for JSON
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          
          # Call DeepSeek API
          RESPONSE=$(curl -s -X POST "https://api.deepseek.com/chat/completions" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -d "{
              \"model\": \"deepseek-chat\",
              \"messages\": [{\"role\": \"user\", \"content\": $ESCAPED_PROMPT}],
              \"temperature\": 0.7,
              \"max_tokens\": 1000
            }")
          
          # Extract the changelog from response
          CHANGELOG=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          
          if [ -n "$CHANGELOG" ] && [ "$CHANGELOG" != "null" ]; then
            echo "âœ… AI Changelog generated successfully!"
            
            # Create release notes
            cat > release_notes.txt << EOF
        # ðŸš€ Woo Envios v${VERSION}

        ${CHANGELOG}

        ---
        
        ðŸ“… **Data:** $(date +"%d/%m/%Y")
        ðŸ“¦ **Arquivo:** \`woo-envios.zip\`
        ðŸ”„ **AtualizaÃ§Ã£o automÃ¡tica:** DisponÃ­vel no painel WordPress
        
        > âš¡ Changelog gerado automaticamente com IA
        EOF
          else
            echo "âš ï¸ AI response empty, using fallback..."
            # Fallback to manual changelog
            cat > release_notes.txt << EOF
        # ðŸš€ Woo Envios v${VERSION}

        ## ðŸ“‹ MudanÃ§as nesta versÃ£o

        ${COMMITS}

        ---
        
        ðŸ“… **Data:** $(date +"%d/%m/%Y")
        ðŸ“¦ **Arquivo:** \`woo-envios.zip\`
        EOF
          fi
        else
          echo "âš ï¸ No DeepSeek API key, using commit-based changelog..."
          
          # Fallback: Generate changelog from commits directly
          cat > release_notes.txt << EOF
        # ðŸš€ Woo Envios v${VERSION}

        ## ðŸ“‹ MudanÃ§as nesta versÃ£o

        ${COMMITS}

        ---
        
        ðŸ“… **Data:** $(date +"%d/%m/%Y")
        ðŸ“¦ **Arquivo:** \`woo-envios.zip\`
        ðŸ”„ **AtualizaÃ§Ã£o automÃ¡tica:** DisponÃ­vel no painel WordPress
        EOF
        fi
        
        echo "ðŸ“ Release notes generated:"
        cat release_notes.txt

    - name: Commit Version Bump
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add woo-envios.php
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "chore: bump version to ${{ steps.bump_version.outputs.new_version }} [skip ci]"
          git push
        fi

    - name: Create Zip Artifact
      run: |
        mkdir -p build/woo-envios
        
        rsync -av --progress . build/woo-envios \
          --exclude .git \
          --exclude .github \
          --exclude build \
          --exclude composer.json \
          --exclude composer.lock \
          --exclude .gitignore \
          --exclude test-*.php \
          --exclude commits.txt \
          --exclude release_notes.txt
        
        cd build
        zip -r ../woo-envios.zip woo-envios

    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: v${{ steps.bump_version.outputs.new_version }}
        name: "ðŸš€ Woo Envios v${{ steps.bump_version.outputs.new_version }}"
        artifacts: "woo-envios.zip"
        token: ${{ secrets.GITHUB_TOKEN }}
        bodyFile: release_notes.txt
        makeLatest: true

    - name: Update CHANGELOG.md
      run: |
        VERSION="${{ steps.bump_version.outputs.new_version }}"
        DATE=$(date +"%Y-%m-%d")
        COMMITS=$(cat commits.txt)
        
        # Create new changelog entry
        NEW_ENTRY="## [${VERSION}] - ${DATE}

        ${COMMITS}

        "
        
        # Prepend to CHANGELOG.md
        if [ -f "CHANGELOG.md" ]; then
          echo -e "${NEW_ENTRY}\n$(cat CHANGELOG.md)" > CHANGELOG.md
        else
          echo -e "# Changelog\n\n${NEW_ENTRY}" > CHANGELOG.md
        fi
        
        # Commit changelog
        git add CHANGELOG.md
        if ! git diff --staged --quiet; then
          git commit -m "docs: update CHANGELOG.md for v${VERSION} [skip ci]"
          git push
        fi
